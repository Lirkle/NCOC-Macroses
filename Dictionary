Option Explicit

' ===== SETTINGS =====
Private Const DICT_NAME As String = "RedUnderlinedWords.dic"

Public Sub AddMisspelledWordsToDictionary_FromPPT()
    Dim wordApp As Object           ' Word.Application
    Dim dictObj As Object           ' Word.Dictionary
    Dim dictPath As String

    On Error GoTo EH

    Set wordApp = GetOrCreateWordApp()
    dictPath = GetDefaultUProofFolder() & "\" & DICT_NAME
    Set dictObj = GetOrCreateDictionary(wordApp, dictPath)

    Dim added As Object ' Scripting.Dictionary
    Set added = CreateObject("Scripting.Dictionary")

    Dim sld As Slide, shp As Shape
    For Each sld In ActivePresentation.Slides
        For Each shp In sld.Shapes
            ProcessShapeForMisspell shp, wordApp, dictObj, added
        Next shp
    Next sld

    On Error Resume Next
    dictObj.Save
    On Error GoTo 0

    MsgBox "Done." & vbCrLf & _
           "Added words: " & CStr(added.Count) & vbCrLf & _
           "Dictionary: " & dictPath, vbInformation, "Add to Dictionary"
    Exit Sub

EH:
    MsgBox "Error " & Err.Number & ":" & vbCrLf & Err.Description, vbCritical, "Add to Dictionary"
End Sub

' ===== SHAPES =====
Private Sub ProcessShapeForMisspell(ByVal shp As Shape, ByVal wordApp As Object, ByVal dictObj As Object, ByVal added As Object)
    On Error Resume Next

    ' Normal text
    If shp.HasTextFrame Then
        If shp.TextFrame.HasText Then
            AddMisspelledFromString shp.TextFrame.TextRange.Text, wordApp, dictObj, added
        End If
    End If

    ' Tables
    If shp.HasTable Then
        Dim r As Long, c As Long
        For r = 1 To shp.Table.Rows.Count
            For c = 1 To shp.Table.Columns.Count
                AddMisspelledFromString shp.Table.Cell(r, c).Shape.TextFrame.TextRange.Text, wordApp, dictObj, added
            Next c
        Next r
    End If

    ' Groups
    If shp.Type = msoGroup Then
        Dim i As Long
        For i = 1 To shp.GroupItems.Count
            ProcessShapeForMisspell shp.GroupItems(i), wordApp, dictObj, added
        Next i
    End If

    On Error GoTo 0
End Sub

' ===== SPELL CHECK + ADD =====
Private Sub AddMisspelledFromString(ByVal text As String, ByVal wordApp As Object, ByVal dictObj As Object, ByVal added As Object)
    Dim tokens() As String
    Dim t As Variant
    Dim w As String

    If Len(text) = 0 Then Exit Sub

    tokens = SplitToWordTokens(text)

    For Each t In tokens
        w = NormalizeWord(CStr(t))
        If IsSkippableWord(w) Then GoTo ContinueNext

        ' If Word marks it as misspelled - add to custom dictionary
        If Not wordApp.CheckSpelling(w) Then
            If Not added.Exists(LCase$(w)) Then
                dictObj.AddWord w
                added.Add LCase$(w), True
            End If
        End If

ContinueNext:
    Next t
End Sub

Private Function IsSkippableWord(ByVal w As String) As Boolean
    w = Trim$(w)
    If Len(w) < 2 Then IsSkippableWord = True: Exit Function

    ' Skip pure numbers
    If IsNumeric(w) Then IsSkippableWord = True: Exit Function

    IsSkippableWord = False
End Function

' ===== TOKENIZE / NORMALIZE =====
Private Function SplitToWordTokens(ByVal s As String) As String()
    Dim tmp As String
    tmp = Replace(s, vbCr, " ")
    tmp = Replace(tmp, vbLf, " ")
    tmp = Replace(tmp, vbTab, " ")
    tmp = Replace(tmp, ChrW(160), " ") ' NBSP
    SplitToWordTokens = Split(tmp, " ")
End Function

Private Function NormalizeWord(ByVal s As String) As String
    s = Trim$(s)
    If Len(s) = 0 Then Exit Function

    ' Trim junk on left
    Do While Len(s) > 0 And Not IsWordChar(Mid$(s, 1, 1))
        s = Mid$(s, 2)
    Loop

    ' Trim junk on right
    Do While Len(s) > 0 And Not IsWordChar(Mid$(s, Len(s), 1))
        s = Left$(s, Len(s) - 1)
    Loop

    NormalizeWord = s
End Function

Private Function IsWordChar(ByVal ch As String) As Boolean
    ' Allow letters/digits, hyphen, apostrophe
    Dim code As Long
    If Len(ch) = 0 Then Exit Function

    If ch = "-" Or ch = "'" Then
        IsWordChar = True
        Exit Function
    End If

    code = AscW(ch)

    ' digits
    If code >= 48 And code <= 57 Then IsWordChar = True: Exit Function

    ' latin
    If (code >= 65 And code <= 90) Or (code >= 97 And code <= 122) Then IsWordChar = True: Exit Function

    ' cyrillic + yo
    If (code >= 1040 And code <= 1103) Or code = 1025 Or code = 1105 Then IsWordChar = True: Exit Function

    IsWordChar = False
End Function

' ===== WORD + DICT =====
Private Function GetOrCreateWordApp() As Object
    On Error Resume Next
    Set GetOrCreateWordApp = GetObject(, "Word.Application")
    On Error GoTo 0

    If GetOrCreateWordApp Is Nothing Then
        Set GetOrCreateWordApp = CreateObject("Word.Application")
    End If
End Function

Private Function GetOrCreateDictionary(ByVal wordApp As Object, ByVal dictPath As String) As Object
    Dim dicts As Object
    Dim i As Long

    Set dicts = wordApp.CustomDictionaries

    For i = 1 To dicts.Count
        If LCase$(dicts(i).Path) = LCase$(dictPath) Then
            Set GetOrCreateDictionary = dicts(i)
            Exit Function
        End If
    Next i

    If Dir$(dictPath) = "" Then
        CreateEmptyFile dictPath
    End If

    Set GetOrCreateDictionary = dicts.Add(dictPath)
End Function

Private Sub CreateEmptyFile(ByVal path As String)
    Dim f As Integer
    EnsureFolderExists Left$(path, InStrRev(path, "\") - 1)
    f = FreeFile
    Open path For Output As #f
    Print #f, ""
    Close #f
End Sub

Private Sub EnsureFolderExists(ByVal folderPath As String)
    If Len(folderPath) = 0 Then Exit Sub
    If Dir$(folderPath, vbDirectory) = "" Then MkDir folderPath
End Sub

Private Function GetDefaultUProofFolder() As String
    GetDefaultUProofFolder = Environ$("APPDATA") & "\Microsoft\UProof"
End Function
